<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/edit">
<body>
<div layout:fragment="page-level-style">
	<link th:href="@{/assets/global/plugins/jquery-nestable/jquery.nestable.css}" rel="stylesheet" type="text/css" />
</div>
<div layout:fragment="page-level-script">
	<script th:src="@{/assets/global/plugins/jquery-nestable/jquery.nestable.js}" type="text/javascript"></script>
	<script type="text/javascript">
		// <![CDATA[
		var UINestable = function () {

			var updateOutput = function (e) {
				var list = e.length ? e : $(e.target),
						output = list.data('output');
				if (window.JSON) {
					output.val(window.JSON.stringify(list.nestable('serialize'))); //, null, 2));
				} else {
					output.val('JSON browser support required for this demo.');
				}
			};


			return {
				//main function to initiate the module
				init: function () {

					$('#command_list').nestable();
				}

			};

		}();

		jQuery.fn.serializeObject = function() {
			var obj = null;
			try {
				if(this[0].tagName && this[0].tagName.toUpperCase() == "FORM" ) {
					var arr = this.serializeArray();
					if (arr) {
						obj = {};
						jQuery.each(arr, function() {
							obj[this.name] = this.value;
						});
					}
				}
			} catch(e) {
				console.log(e.message);
			} finally {

			}
			return obj;
		};

		var addCommand = function() {
			var modal = $(this).parents('.modal:first');
			var form = modal.find("form");
			console.log('form = ' + form.attr('name'));
			var formData = form.serializeObject();
			console.log(JSON.stringify(formData));

			// var item = $("<li class='dd-item' data-id='" + formData.name+ "'><div class='dd-handle'>" + formData.name + "</div></li>");
			var $div = $("<div class='dd-handle' />").text(formData.name);
			var $li = $("<li class='dd-item' />")
			$li.attr('data-id', formData.name);
			$li.attr('data-json', JSON.stringify(formData));
			$li.append($div);

			$("#command_list ol").append($li);
			form.trigger("reset");
			modal.modal("hide")
		};

		jQuery(document).ready(function() {
			UINestable.init();

			var editForm = $("#editForm");
			editForm.submit(function() {
				var commands = new Array();
				var commandIndex = 0;
				$(".dd-item").each(function(index) {
					var commandJsonString = $(this).attr("data-json");
					if (typeof(commandJsonString) != "undefined") {
						console.log( commandIndex + ": " + commandJsonString );
						var command = JSON.parse(commandJsonString);
						commands[commandIndex++] = command;
					}
				});
				console.log('commands = ' +  JSON.stringify(commands) );
				$(this).find('input[name="commands"]').val(JSON.stringify(commands));
				console.log('form.comands = ' + $(this).find('input[name="commands"]').val());
				return true;
			});


			$(".modal-submit").click(addCommand);


		});
	// ]]>
	</script>
</div>

		<div class="row" layout:fragment="content-main">
			<div class="col-md-12">
				<!-- BEGIN BORDERED TABLE PORTLET-->
				<div class="portlet light bordered">
					<div class="portlet-title">
						<div class="caption">
							<i class="icon-settings font-dark"></i>
							<span class="caption-subject font-dark sbold uppercase">Install Script</span>
						</div>
					</div>
					<div class="portlet-body form">
						<form class="form-horizontal" role="form" id="editForm" th:action="${action} == 'update' ? @{/app/template/{id}/script/{scriptId}/update(id=${id},scriptId=${scriptId})} : @{/app/template/{id}/script/create(id=${id})}" th:object="${editForm}" method="post">
							<input type="hidden" th:field="*{commands}" />
							<div class="form-body">
								<div class="form-group" th:class="${#fields.hasErrors('name')} ? 'form-group has-error' : 'form-group'">
									<label class="col-md-3 control-label">Name</label>
									<div class="col-md-9">
										<input type="text" class="form-control" th:field="*{name}" placeholder="Enter text" />
										<span class="help-block" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"> A block of help text. </span>
									</div>
								</div>
								<div class="form-group" th:class="${#fields.hasErrors('description')} ? 'form-group has-error' : 'form-group'">
									<label class="col-md-3 control-label">Description</label>
									<div class="col-md-9">
										<input type="text" class="form-control" th:field="*{description}" placeholder="Enter text" />
										<span class="help-block" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"> A block of help text. </span>
									</div>
								</div>

								<div class="form-group" th:class="${#fields.hasErrors('version')} ? 'form-group has-error' : 'form-group'">
									<label class="col-md-3 control-label">Version</label>
									<div class="col-md-9">
										<input type="text" class="form-control" th:field="*{version}" placeholder="Enter text" />
										<span class="help-block" th:if="${#fields.hasErrors('version')}" th:errors="*{version}"> A block of help text. </span>
									</div>
								</div>

								<div class="form-group" th:class="${#fields.hasErrors('commands')} ? 'form-group has-error' : 'form-group'">
									<label class="col-md-3 control-label">Commands</label>
									<div class="col-md-9">
										<div class="portlet light bordered">
											<div class="portlet-title">
												<div class="caption">
													<i class="icon-bubble font-red"></i>
													<span class="caption-subject font-red sbold uppercase">Nestable List 2</span>
												</div>
												<div class="actions">
													<div class="btn-group">
														<a class="btn green-haze btn-outline btn-circle btn-sm" href="javascript:;" data-toggle="dropdown" data-hover="dropdown" data-close-others="true" aria-expanded="false"> Actions
															<i class="fa fa-angle-down"></i>
														</a>
														<ul class="dropdown-menu pull-right">
															<li>
																<a data-toggle="modal" href="#execute-command"> Add Execute Command</a>
															</li>
															<li>
																<a data-toggle="modal" href="#file-create-command"> Add File Create Command</a>
															</li>
															<li>
																<a data-toggle="modal" href="#file-remove-command"> Add File Remove Command</a>
															</li>
														</ul>
													</div>
												</div>
											</div>
											<div class="portlet-body" style="display: block;">
												<div class="dd" id="command_list">
													<ol class="dd-list">
														<li class="dd-item" th:each="command : ${commandList}" th:attr="data-id=${command.id},data-json=${JSON.stringify(command)}">
															<div class="dd-handle" th:text="${command.name}"> Item 14 </div>
														</li>
													</ol>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="form-actions">
								<div class="row">
									<div class="col-md-offset-3 col-md-9">
										<button type="submit" class="btn green">Submit</button>
										<button type="button" class="btn default">Cancel</button>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
				<!-- END BORDERED TABLE PORTLET-->
			</div>

			<!-- BEGIN modal -->
			<div class="modal fade bs-modal-lg" id="execute-command" tabindex="-1" role="dialog" aria-hidden="true">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
							<h4 class="modal-title">Modal Title</h4>
						</div>
						<div class="modal-body">
							<form class="form-horizontal" role="form" name="execute-command-form">
								<input type="hidden" name="type" th:value="EXECUTE"/>
								<div class="form-body">
									<div class="form-group">
										<label class="col-md-3 control-label">Name</label>
										<div class="col-md-9">
											<input type="text" class="form-control" name="name" placeholder="Enter text" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">Command Shell</label>
										<div class="col-md-9">
											<select class="form-control" name="commandShell">
												<option th:each="shell : ${commandShells}"
														th:value="${shell.name()}" th:text="${shell.name()}">Option 1</option>
											</select>
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">Command Line</label>
										<div class="col-md-9">
											<input type="text" class="form-control" name="commandLine" placeholder="Enter text" />
										</div>
									</div>
								</div>
							</form>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn dark btn-outline" data-dismiss="modal">Close</button>
							<button type="button" class="btn green modal-submit" id="1">Save changes</button>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade bs-modal-lg" id="file-create-command" tabindex="-1" role="dialog" aria-hidden="true">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
							<h4 class="modal-title">Modal Title</h4>
						</div>
						<div class="modal-body">
							<form class="form-horizontal" role="form" name="file-create-command-form">
								<input type="hidden" name="type" th:value="FILE_CREATE"/>
								<div class="form-body">
									<div class="form-group">
										<label class="col-md-3 control-label">Name</label>
										<div class="col-md-9">
											<input type="text" class="form-control" name="name" placeholder="Enter Name" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">Filename</label>
										<div class="col-md-9">
											<input type="text" class="form-control" name="filename" placeholder="Enter Filename" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">Content</label>
										<div class="col-md-9">
											<textarea class="form-control" name="content" rows="6"></textarea>
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">File Mode</label>
										<div class="col-md-9">
											<div class="checkbox-list">
												<label class="checkbox-inline">
													<span class=""><input type="checkbox" name="execute" /></span>Execute </label>
											</div>
										</div>
									</div>
								</div>
							</form>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn dark btn-outline" data-dismiss="modal">Close</button>
							<button type="button" class="btn green modal-submit" id="2">Save changes</button>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade bs-modal-lg" id="file-remove-command" tabindex="-1" role="dialog" aria-hidden="true">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
							<h4 class="modal-title">Modal Title</h4>
						</div>
						<div class="modal-body">
							<form class="form-horizontal" role="form" name="file-create-command-form">
								<input type="hidden" name="type" th:value="FILE_REMOVE"/>
								<div class="form-body">
									<div class="form-group">
										<label class="col-md-3 control-label">Name</label>
										<div class="col-md-9">
											<input type="text" class="form-control" name="name" placeholder="Enter Name" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">Filename</label>
										<div class="col-md-9">
											<input type="text" class="form-control" name="filename" placeholder="Enter Filename" />
										</div>
									</div>
								</div>
							</form>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn dark btn-outline" data-dismiss="modal">Close</button>
							<button type="button" class="btn green modal-submit" id="2">Save changes</button>
						</div>
					</div>
				</div>
			</div>
			<!-- END modal -->
		</div>

</body>
</html>
